<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FIGBOT — Shared Load Command Center</title>
<meta name="color-scheme" content="dark" />
<style>
:root {
  --fg: rgba(245,245,255,0.92);
  --muted: rgba(245,245,255,0.68);
  --glass: rgba(12, 14, 24, 0.55);
  --glass2: rgba(10, 12, 22, 0.42);
  --stroke: rgba(255,255,255,0.14);
  --shadow: 0 18px 60px rgba(0,0,0,0.55);
  --good: rgba(60, 220, 160, 0.95);
  --bad: rgba(255, 86, 86, 0.95);
  --warn: rgba(255, 214, 79, 0.95);

  /* set by live state; NOT user-adjustable */
  --pulse: 0.28; --shake: 0.09; --chrom: 0.20;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  color:var(--fg);
  background:#050510;
  overflow-x:hidden;
}

#art{position:fixed; inset:0; width:100%; height:100%; z-index:-3; background:#050510;}
.veil{position:fixed; inset:0; z-index:-2; pointer-events:none;
  background: radial-gradient(70% 60% at 50% 35%, rgba(0,0,0,0.06), rgba(0,0,0,0.72)),
              linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.72));
}
.ink{position:fixed; inset:-2vh -2vw; z-index:-1; pointer-events:none;
  background:url('/assets/ggg.jpg') center/cover no-repeat;
  filter: blur(10px) contrast(1.05) saturate(0.95);
  opacity:0.22; mix-blend-mode:multiply;
  transform: scale(1.05);
}
.ribbon{position:fixed; left:0; right:0; bottom:-10px; height:140px; z-index:-2; pointer-events:none;
  background:url('/assets/ggggggggggggg.png') center/cover no-repeat;
  opacity:0.22; filter: blur(10px) saturate(1.1); mix-blend-mode:screen;
  transform: translateY(calc(var(--pulse) * 10px));
}

.wrap{max-width:1240px; margin:0 auto; padding:28px 18px 80px;}
.brand{display:flex; align-items:flex-end; justify-content:space-between; gap:16px; margin-bottom:18px;}
.lock{display:flex; align-items:center; gap:14px; min-width:0;}
.badge{width:58px; height:58px; border-radius:18px; border:1px solid rgba(255,255,255,0.18);
  background: radial-gradient(100% 100% at 20% 10%, rgba(255,255,255,0.35), rgba(255,255,255,0.05)),
              linear-gradient(135deg, rgba(255,64,129,0.85), rgba(94,234,212,0.75));
  box-shadow: 0 18px 50px rgba(0,0,0,0.45);
  position:relative; overflow:hidden;
}
.badge:after{content:""; position:absolute; inset:-40%;
  background:url('/assets/gg.jpg') center/cover no-repeat;
  opacity:0.55; mix-blend-mode:overlay;
  transform: rotate(8deg);
  filter:saturate(1.15) contrast(1.1);
}
h1{margin:0; font-size:clamp(42px, 6vw, 78px); font-weight:900; letter-spacing:.04em; line-height:.9; text-transform:uppercase;
  filter: drop-shadow(0 18px 24px rgba(0,0,0,0.55)); position:relative;
}
h1:before,h1:after{content:"FIGBOT"; position:absolute; left:0; top:0; z-index:-1;
  opacity: calc(0.18 + var(--chrom) * 0.35); mix-blend-mode:screen;}
h1:before{color: rgba(94,234,212,0.95); transform: translate(calc(var(--shake)*3px), calc(var(--shake)*-2px));}
h1:after {color: rgba(255,64,129,0.95); transform: translate(calc(var(--shake)*-3px), calc(var(--shake)*2px));}
.tag{margin:6px 0 0; color:var(--muted); font-weight:700; max-width:70ch;}
.pills{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
.pill{padding:8px 12px; border-radius:999px; background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.12);
  font-weight:800; font-size:12px; letter-spacing:.06em; text-transform:uppercase;
  backdrop-filter: blur(10px);
}
.pill b{color:rgba(255,255,255,0.96); font-weight:900;}

.card{
  background: linear-gradient(180deg, var(--glass), var(--glass2));
  border:1px solid var(--stroke);
  border-radius:22px;
  box-shadow:var(--shadow);
  overflow:hidden;
  position:relative;
  backdrop-filter: blur(16px) saturate(1.1);
}
.card:before{content:""; position:absolute; inset:0; pointer-events:none;
  background: radial-gradient(120% 140% at 12% 0%, rgba(255,255,255,0.12), rgba(255,255,255,0.02)),
              url('/assets/ggg.jpg') center/cover no-repeat;
  opacity:0.18; mix-blend-mode:overlay;
}
.hd{padding:14px 16px 10px; display:flex; align-items:baseline; justify-content:space-between; gap:12px;
  border-bottom:1px solid rgba(255,255,255,0.10);
}
.hd h2{margin:0; font-size:14px; letter-spacing:.08em; text-transform:uppercase; color:rgba(255,255,255,0.86);}
.sub{color:rgba(245,245,255,0.68); font-weight:800; font-size:12px;}
.bd{padding:14px 16px 16px;}

.controls{display:grid; grid-template-columns:1fr; gap:14px; margin:18px 0 18px;}
@media(min-width:920px){.controls{grid-template-columns:1.10fr 0.90fr;}}

.btnrow{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
button{border:0; cursor:pointer; padding:12px 14px; border-radius:14px; font-weight:900; letter-spacing:.08em; text-transform:uppercase;
  box-shadow:0 14px 40px rgba(0,0,0,0.35); transition:transform 160ms ease;
}
button:hover{transform: translateY(-1px);}
.start{background: linear-gradient(135deg, rgba(60,220,160,0.95), rgba(94,234,212,0.9)); color:rgba(0,0,0,0.88);}
.stop{background: linear-gradient(135deg, rgba(255,86,86,0.95), rgba(255,64,129,0.9)); color:rgba(255,255,255,0.92);}
.apply{background: linear-gradient(135deg, rgba(255,214,79,0.95), rgba(255,151,79,0.9)); color:rgba(0,0,0,0.88);}
input{width:100%; padding:11px 12px; border-radius:14px; border:1px solid rgba(255,255,255,0.14);
  background:rgba(0,0,0,0.26); color:rgba(255,255,255,0.92);
}

.grid{display:grid; grid-template-columns:1fr; gap:14px; margin-top:14px;}
@media(min-width:980px){.grid{grid-template-columns:1.2fr .8fr;}}

table{width:100%; border-collapse:collapse; font-size:13px; color:rgba(255,255,255,0.86);}
th,td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,0.10);}
th{font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:rgba(245,245,255,0.72); font-weight:900;}

.beats{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
.beat{padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.10);
  background:rgba(0,0,0,0.18);
  font-weight:900; letter-spacing:.08em; text-transform:uppercase; font-size:11px;
  opacity:0.55;
}
.beat.on{opacity:1.0; box-shadow: 0 0 0 4px rgba(94,234,212,0.10);}

.msg{border:1px solid rgba(255,255,255,0.12); border-radius:18px; padding:12px 12px; background:rgba(0,0,0,0.18);}
.msgTitle{font-weight:900; letter-spacing:.06em; text-transform:uppercase; font-size:12px;}
.msgText{margin-top:6px; color:rgba(245,245,255,0.78); font-weight:650; line-height:1.35;}
.msg.warn{border-color: rgba(255,214,79,0.35);}
.msg.warn .msgTitle{color: rgba(255,214,79,0.95);}

.smallNote{margin-top:10px; color:rgba(245,245,255,0.60); font-weight:700; font-size:12px;}
</style>
</head>
<body>
<canvas id="art"></canvas>
<div class="veil"></div>
<div class="ink"></div>
<div class="ribbon"></div>

<div class="wrap">
  <div class="brand">
    <div class="lock">
      <div class="badge"></div>
      <div style="min-width:0">
        <h1>FIGBOT</h1>
        <div class="tag">Shared load trading console. Calm clarity. No visual sliders. Build 2026-01-06 01:25:25Z</div>
        <div class="beats">
          <div class="beat" id="bObserve">Observe</div>
          <div class="beat" id="bThink">Think</div>
          <div class="beat" id="bDecide">Decide</div>
          <div class="beat" id="bAct">Act</div>
          <div class="beat" id="bLearn">Learn</div>
        </div>
      </div>
    </div>
    <div class="pills">
      <div class="pill">Status: <b id="pStatus">—</b></div>
      <div class="pill">TF: <b id="pTF">—</b></div>
      <div class="pill">Cycles: <b id="pCycles">0</b></div>
      <div class="pill">Calls (10m): <b id="pCalls">0</b></div>
      <div class="pill">Errors (10m): <b id="pErrs">0</b></div>
    </div>
  </div>

  <div class="controls">
    <div class="card">
      <div class="hd"><h2>Controls</h2><div class="sub" id="lastUpdate">—</div></div>
      <div class="bd">
        <div class="btnrow">
          <button class="start" id="btnStart">Start</button>
          <button class="stop" id="btnStop">Stop</button>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:10px; margin-top:12px">
          <div>
            <div class="sub">Cycle seconds</div>
            <input id="cycleSeconds" type="number" min="1" step="1" placeholder="e.g., 60" />
          </div>
          <div>
            <div class="sub">Timeframes (comma)</div>
            <input id="timeframes" type="text" placeholder="e.g., 1m, 5m, 15m" />
          </div>
          <div style="align-self:end"><button class="apply" id="btnApply">Apply</button></div>
        </div>
        <div class="smallNote" id="errBanner"></div>
      </div>
    </div>

    <div class="card">
      <div class="hd"><h2>Coach</h2><div class="sub">You don't have to hold it alone</div></div>
      <div class="bd" id="coachBox" style="display:grid; gap:10px"></div>

      <div class="hd"><h2>Keys</h2><div class="sub">Optional runtime onboarding</div></div>
      <div class="bd">
        <div style="display:grid; gap:10px">
          <div>
            <div class="sub">APCA_API_KEY_ID</div>
            <input id="kKey" type="password" autocomplete="off" placeholder="Alpaca key id" />
          </div>
          <div>
            <div class="sub">APCA_API_SECRET_KEY</div>
            <input id="kSecret" type="password" autocomplete="off" placeholder="Alpaca secret key" />
          </div>
          <div>
            <div class="sub">APCA_API_BASE_URL (optional)</div>
            <input id="kBase" type="text" autocomplete="off" placeholder="https://paper-api.alpaca.markets" />
          </div>
          <div class="btnrow">
            <button class="apply" id="btnKeys">Set Keys</button>
          </div>
          <div class="smallNote">
            Keys are stored <b>in memory</b> for this running instance only. For persistence, set env vars in Railway.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="hd"><h2>Recent trades</h2><div class="sub" id="tMeta">—</div></div>
      <div class="bd">
        <div style="overflow:auto; max-height:360px">
          <table>
            <thead><tr><th>Time</th><th>Asset</th><th>Action</th><th>Price</th><th>Qty</th></tr></thead>
            <tbody id="tradesBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd"><h2>Predictions + Calls</h2><div class="sub">Shared load in action</div></div>
      <div class="bd" style="display:grid; gap:14px">
        <div style="overflow:auto; max-height:180px">
          <table><thead><tr><th>Time</th><th>Asset</th><th>TF</th><th>Dir</th><th>Conf</th></tr></thead>
          <tbody id="predBody"></tbody></table>
        </div>
        <div style="overflow:auto; max-height:180px">
          <table><thead><tr><th>Time</th><th>Model</th><th>Status</th><th>Latency</th></tr></thead>
          <tbody id="callsBody"></tbody></table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
async function jget(u){ const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(u+" "+r.status); return r.json(); }
async function jpost(u,b=null){ const r=await fetch(u,{method:"POST",headers:b?{"Content-Type":"application/json"}:undefined,body:b?JSON.stringify(b):undefined}); if(!r.ok) throw new Error(u+" "+r.status); return r.json(); }
function clamp01(x){ return Math.max(0, Math.min(1, x)); }
function setVars(pulse,shake,chrom){ const s=document.documentElement.style; s.setProperty("--pulse", String(clamp01(pulse))); s.setProperty("--shake", String(clamp01(shake))); s.setProperty("--chrom", String(clamp01(chrom))); }

function render(tbody, rows, cols) {
  tbody.innerHTML="";
  for(const r of rows) {
    const tr=document.createElement("tr");
    for(const c of cols) {
      const td=document.createElement("td");
      td.textContent = (r[c] ?? "");
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
}

function beat(id,on){ const el=$(id); if(!el) return; el.classList.toggle("on", !!on); }

function renderCoach(coach) {
  const box = $("coachBox");
  box.innerHTML = "";
  for (const m of (coach.messages||[])) {
    const div = document.createElement("div");
    div.className = "msg" + (m.role==="warning" ? " warn" : "");
    div.innerHTML = `<div class="msgTitle">${m.title||"Message"}</div><div class="msgText">${m.text||""}</div>`;
    box.appendChild(div);
  }
}

let prevScore=null, ema=0;

async function refresh() {
  try {
    const [status, coach, trades, preds, calls, stats] = await Promise.all([
      jget("/status"),
      jget("/api/coach"),
      jget("/api/trades/recent"),
      jget("/api/predictions/recent"),
      jget("/api/calls/recent"),
      jget("/api/stats"),
    ]);

    $("pStatus").textContent = status.running ? "Running" : "Stopped";
    $("pTF").textContent = status.last_timeframe || "—";
    $("pCycles").textContent = String(status.cycles ?? 0);

    $("pCalls").textContent = String(status.activity?.calls_10m ?? 0);
    $("pErrs").textContent = String(status.activity?.errors_10m ?? 0);

    // "Beats": simple rhythmic state machine based on activity
    beat("bObserve", true);
    beat("bThink",  status.running);
    beat("bDecide", (status.activity?.preds_10m ?? 0) > 0);
    beat("bAct",    (status.activity?.trades_24h ?? 0) > 0);
    beat("bLearn",  (stats.evaluated_predictions ?? 0) > 0);

    $("errBanner").textContent = status.last_error
      ? ("Last error: " + status.last_error)
      : (status.alpaca_keys_present ? "" : "Note: Alpaca keys missing — predictions run, orders will not place.");

    renderCoach(coach);

    render($("tradesBody"), Array.isArray(trades)?trades:[], ["timestamp","asset","action","price","quantity"]);
    render($("predBody"), Array.isArray(preds)?preds:[], ["timestamp","asset","timeframe","direction","confidence"]);
    render($("callsBody"), Array.isArray(calls)?calls:[], ["timestamp","model","status","latency_ms"]);

    $("lastUpdate").textContent = "Updated " + new Date().toLocaleTimeString();
    $("tMeta").textContent = (Array.isArray(trades)?trades.length:0) + " rows";

    // visuals respond (no knobs)
    const activity = (status.activity?.calls_10m ?? 0) * 0.015 + (status.activity?.trades_24h ?? 0) * 0.01;
    const score = Number(stats.avg_correctness_score ?? 0);
    if(prevScore!==null) ema = ema*0.88 + Math.abs(score-prevScore)*0.12;
    prevScore=score;
    setVars(0.18 + activity + ema*3 + (status.running?0.08:0), 0.08 + activity*1.2 + ema*4, 0.18 + activity + ema*3);
  } catch (e) {
    $("errBanner").textContent = "UI refresh error: " + (e.message||e);
  }
}

$("btnStart").onclick = async()=>{ try{ await jpost("/start"); }finally{ refresh(); } };
$("btnStop").onclick  = async()=>{ try{ await jpost("/stop"); }finally{ refresh(); } };
$("btnApply").onclick = async()=>{
  const cycle_seconds = parseInt($("cycleSeconds").value||"0",10);
  const timeframes = $("timeframes").value||"";
  try{ await jpost("/config", {cycle_seconds, timeframes}); }finally{ refresh(); }
};

$("btnKeys").onclick = async()=>{
  const body = {
    APCA_API_KEY_ID: $("kKey").value || "",
    APCA_API_SECRET_KEY: $("kSecret").value || "",
    APCA_API_BASE_URL: $("kBase").value || ""
  };
  try {
    const r = await jpost("/api/keys", body);
    $("errBanner").textContent = r.ok ? "Keys set for this session." : (r.error || "Key set failed.");
  } catch(e) {
    $("errBanner").textContent = "Key set failed: " + (e.message||e);
  }
};

// Art engine: combine all artworks into one field, live responsive (no user controls)
const art = document.getElementById("art");
const ctx = art.getContext("2d", {alpha:false});
const layers = [
  {src:"/assets/ggg.jpg", mode:"multiply", a:0.70},
  {src:"/assets/gg.jpg", mode:"screen", a:0.44},
  {src:"/assets/gggg.jpg", mode:"overlay", a:0.26},
  {src:"/assets/ggggggg.jpg", mode:"soft-light", a:0.22},
  {src:"/assets/g.jpg", mode:"overlay", a:0.10},
];
function fit(){ art.width=Math.floor(innerWidth*devicePixelRatio); art.height=Math.floor(innerHeight*devicePixelRatio); }
addEventListener("resize", fit); fit();
function load(src){ return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=src; }); }
(async()=>{ for(const l of layers){ try{ l.img=await load(l.src); }catch{ l.img=null; } } })();

let t=0;
function draw() {
  const w=art.width,h=art.height; ctx.fillStyle="#050510"; ctx.fillRect(0,0,w,h);
  const s=getComputedStyle(document.documentElement);
  const pulse=parseFloat(s.getPropertyValue("--pulse"))||0.3;
  const shake=parseFloat(s.getPropertyValue("--shake"))||0.1;
  const cx=w/2, cy=h/2;
  const rot=(t*0.00022)*(0.6+pulse*1.2);
  for(let i=0;i<layers.length;i++) {
    const l=layers[i]; if(!l.img) continue;
    const drift=(i+1)*0.00018*(0.6+pulse);
    const dx=Math.sin(t*drift)*w*(0.015+shake*0.03);
    const dy=Math.cos(t*drift*1.2)*h*(0.012+shake*0.028);
    ctx.save();
    ctx.globalAlpha = l.a*(0.72+pulse*0.45);
    ctx.globalCompositeOperation = l.mode;
    if(l.src.includes("gggg.jpg")){ ctx.translate(cx,cy); ctx.rotate(rot); ctx.translate(-cx,-cy); }
    const iw=l.img.width*devicePixelRatio, ih=l.img.height*devicePixelRatio;
    const sc=Math.max(w/iw, h/ih);
    const dw=iw*sc, dh=ih*sc;
    const x=(w-dw)/2+dx, y=(h-dh)/2+dy;
    ctx.drawImage(l.img,x,y,dw,dh);
    ctx.restore();
  }
  // vignette
  ctx.save();
  ctx.globalCompositeOperation="multiply"; ctx.globalAlpha=0.85;
  const g=ctx.createRadialGradient(cx,cy,Math.min(w,h)*0.12,cx,cy,Math.max(w,h)*0.75);
  g.addColorStop(0,"rgba(0,0,0,0)"); g.addColorStop(1,"rgba(0,0,0,0.75)");
  ctx.fillStyle=g; ctx.fillRect(0,0,w,h); ctx.restore();

  t+=16; requestAnimationFrame(draw);
}
requestAnimationFrame(draw);

refresh();
setInterval(refresh, 2500);
</script>
</body>
</html>
